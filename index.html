<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لعبة تخمين الفرق - تصميم جديد</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to bottom, #1E3A8A 0%, #172B6B 100%); /* Dark blue gradient from image */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 10px;
            box-sizing: border-box;
            overflow-y: auto;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .game-container {
            background-color: #172B6B; /* Darker blue for container */
            border-radius: 2rem; /* More rounded corners */
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5); /* Stronger shadow */
            padding: 2rem; /* Increased padding */
            max-width: 900px; /* Wider container */
            width: 100%;
            text-align: center;
            border: 3px solid #3B82F6; /* Brighter blue border */
            position: relative;
            color: #E0F2F7;
            display: flex;
            flex-direction: column;
            gap: 1.8rem; /* Increased gap */
        }

        h1 {
            color: #FACC15; /* Yellow title */
            font-size: 2.8rem; /* Larger title */
            margin-bottom: 0.8rem;
            text-shadow: 0 3px 6px rgba(0,0,0,0.4);
            font-weight: 900;
        }
        p.description {
            color: #9CA3AF; /* Grayish description */
            font-size: 1rem;
            margin-bottom: 1.5rem;
        }

        /* Top Bar Section */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(to right, #3B82F6, #60A5FA); /* Blue gradient */
            padding: 0.8rem 1.2rem;
            border-radius: 1rem;
            box-shadow: inset 0 3px 6px rgba(0,0,0,0.3);
            border: 2px solid #60A5FA;
            flex-wrap: wrap;
            gap: 0.8rem;
        }
        .top-bar .info-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            font-weight: 600;
            color: #D1D5DB;
        }
        .top-bar .info-item i {
            color: #FACC15;
        }
        .top-bar .balance-display {
            font-size: 1.3rem; /* Larger balance */
            font-weight: 800;
            color: #34D399; /* Green for balance */
            background-color: #2D3748; /* Darker background */
            padding: 0.4rem 1rem;
            border-radius: 0.8rem;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.3);
            border: 1px solid #34D399;
        }

        /* Main Game Area */
        .main-game-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }
        .timer-center {
            font-size: 4rem; /* Even larger timer */
            font-weight: 900;
            color: #FACC15; /* Bright yellow */
            text-shadow: 0 0 15px #FACC15, 0 0 30px #FACC15; /* Stronger glow */
            margin-bottom: 1.5rem;
            background-color: #2D3748; /* Darker background */
            padding: 1rem 2rem;
            border-radius: 1.5rem;
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
            min-width: 150px;
            border: 3px solid #FACC15; /* Yellow border */
            position: relative;
            z-index: 10;
        }
        .remaining-text {
            position: absolute;
            top: -25px; /* Adjusted position */
            left: 50%;
            transform: translateX(-50%);
            font-size: 1rem;
            color: #D1D5DB;
            background-color: #2D3748;
            padding: 0.3rem 0.8rem;
            border-radius: 0.8rem;
            white-space: nowrap;
            z-index: 1;
            border: 1px solid #4A5568;
        }


        .teams-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); /* Adjusted for 8 teams */
            gap: 1.2rem; /* Increased gap */
            margin-bottom: 1.5rem;
            width: 100%;
        }
        .team-card {
            background: linear-gradient(to bottom, #2D3748, #1A202C); /* Dark gradient for cards */
            border: 3px solid #4A5568; /* Grayish border */
            border-radius: 1.5rem; /* More rounded */
            padding: 1rem; /* Increased padding */
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
            transform: translateZ(0);
        }
        .team-card:hover:not(.selected):not(.disabled):not(.has-bet) {
            transform: scale(1.07) translateY(-5px);
            border-color: #FACC15; /* Yellow hover border */
            box-shadow: 0 10px 20px rgba(250, 204, 21, 0.4);
        }
        .team-card.selected {
            border-color: #34D399; /* Green for selected */
            box-shadow: 0 0 0 5px rgba(52, 211, 153, 0.6);
            transform: scale(1.07);
        }
        .team-card.winning {
            border-color: #10B981; /* Darker green for winning */
            background: linear-gradient(to bottom, #10B981, #065F46); /* Green gradient for win */
            box-shadow: 0 0 0 6px rgba(16, 185, 129, 0.8);
            animation: pulse-win 1s infinite alternate;
        }
        .team-card.losing {
            border-color: #EF4444; /* Red for losing */
            background: linear-gradient(to bottom, #EF4444, #B91C1C); /* Red gradient for lose */
            box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.6);
            animation: shake 0.5s;
        }
        .team-card.disabled {
            opacity: 0.6;
            cursor: not-allowed;
            filter: grayscale(50%); /* Slightly desaturate disabled cards */
        }
        .team-card.has-bet {
            border-color: #60A5FA; /* Blue for bet placed */
            box-shadow: 0 0 0 4px rgba(96, 165, 250, 0.6);
            cursor: default;
            opacity: 0.95;
        }
        .team-card img {
            width: 90px; /* Larger image */
            height: 90px;
            object-fit: contain;
            border-radius: 50%;
            margin-bottom: 0.6rem;
            border: 3px solid #FACC15; /* Yellow border around logo */
            box-shadow: 0 0 8px rgba(250, 204, 21, 0.6);
        }
        .team-card span {
            font-weight: 700;
            color: #E0F2F7;
            font-size: 1rem;
            margin-top: 0.3rem;
            white-space: nowrap;
        }
        .team-card .multiplier {
            font-size: 0.85rem; /* Larger multiplier font */
            color: #FACC15;
            font-weight: bold;
            background-color: rgba(0,0,0,0.4);
            padding: 3px 10px;
            border-radius: 0.6rem;
            margin-top: 0.3rem;
            border: 1px solid rgba(250, 204, 21, 0.5);
        }
        .team-card .bet-amount-display {
            position: absolute;
            top: 8px;
            right: 8px;
            background-color: #FACC15;
            color: #1A202C;
            padding: 3px 10px;
            border-radius: 0.6rem;
            font-size: 0.9rem;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s ease;
            box-shadow: 0 3px 8px rgba(0,0,0,0.3);
            border: 1px solid #EAB308;
        }
        .team-card.has-bet .bet-amount-display {
            opacity: 1;
        }

        /* New highlight for the spinning selection */
        .team-card.selection-highlight {
            border-color: #FACC15; /* Yellow highlight */
            box-shadow: 0 0 15px rgba(250, 204, 21, 0.7), 0 0 30px rgba(250, 204, 21, 0.5); /* Stronger glow */
            transform: scale(1.05);
        }


        .message-area {
            min-height: 3.5rem; /* Increased height */
            font-size: 1.4rem; /* Larger font */
            font-weight: 800;
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #FACC15; /* Yellow for messages */
            background-color: #2D3748;
            padding: 1rem;
            border-radius: 1rem;
            box-shadow: inset 0 3px 6px rgba(0,0,0,0.3);
            border: 2px solid #4A5568;
        }
        .message-area.win { color: #34D399; }
        .message-area.lose { color: #EF4444; }
        .message-area.thinking { color: #FACC15; }
        .message-area.error { color: #EF4444; }
        .message-area.info { color: #9CA3AF; }


        .bet-amounts-group {
            display: flex;
            gap: 1rem; /* Increased gap */
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 1.5rem;
            padding: 1rem 1.5rem;
            background: linear-gradient(to right, #3B82F6, #60A5FA);
            border-radius: 1rem;
            box-shadow: inset 0 3px 6px rgba(0,0,0,0.3);
            border: 2px solid #60A5FA;
        }
        .bet-amount-button {
            background-image: linear-gradient(to right, #DC2626, #EF4444); /* Red gradient for bets */
            color: white;
            padding: 0.6rem 1.2rem; /* Larger padding */
            border-radius: 0.8rem;
            font-size: 0.95rem; /* Larger font */
            font-weight: 800;
            cursor: pointer;
            border: none;
            transition: all 0.2s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            min-width: 60px;
        }
        .bet-amount-button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
            background-image: linear-gradient(to right, #EF4444, #F87171);
        }
        .bet-amount-button:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .bet-amount-button:disabled {
            background-image: linear-gradient(to right, #9CA3AF, #D1D5DB); /* Grayish when disabled */
            cursor: not-allowed;
            box-shadow: none;
            opacity: 0.6;
        }
        /* Style for active bet amount button */
        .bet-amount-button.active-bet-amount {
            border: 2px solid #FACC15; /* Yellow border for active bet */
            box-shadow: 0 0 0 4px rgba(250, 204, 21, 0.5);
            transform: scale(1.05);
        }


        .action-buttons-group {
            display: flex;
            justify-content: center;
            gap: 1.2rem;
            margin-bottom: 1.5rem;
        }
        .action-button {
            background-image: linear-gradient(to right, #FACC15, #FDE047); /* Yellow gradient for action */
            color: #1F2937; /* Dark text */
            padding: 0.7rem 1.6rem;
            border-radius: 0.8rem;
            font-size: 1rem;
            font-weight: 800;
            cursor: pointer;
            border: none;
            transition: all 0.2s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        .action-button.large-value-bet { /* Style for 100 Million button */
            background-image: linear-gradient(to right, #34D399, #6EE7B7); /* Green gradient */
            color: #1F2937;
            padding: 0.7rem 1rem; /* Smaller padding to fit text */
            min-width: 120px; /* Ensure minimum width */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            line-height: 1.2;
            gap: 0.2rem;
        }
        .action-button.large-value-bet .bet-label {
            font-size: 0.75rem;
            font-weight: 600;
        }
        .action-button.large-value-bet .bet-value {
            font-size: 1.1rem;
            font-weight: 900;
        }


        .action-button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
        }
        .action-button:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .action-button:disabled {
            background-image: linear-gradient(to right, #A1A1AA, #D4D4D8);
            cursor: not-allowed;
            opacity: 0.6;
        }


        .bottom-stats-and-results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); /* Adjusted grid for more stats */
            gap: 1.2rem;
            margin-top: 1.8rem;
            padding: 1.5rem;
            background: linear-gradient(to right, #3B82F6, #60A5FA);
            border-radius: 1.5rem;
            box-shadow: inset 0 3px 6px rgba(0,0,0,0.3);
            border: 2px solid #60A5FA;
        }
        .bottom-stats-and-results .stat-block {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.6rem;
        }
        .bottom-stats-and-results .stat-label {
            font-size: 0.95rem;
            color: #D1D5DB;
            font-weight: 600;
            white-space: nowrap;
        }
        .bottom-stats-and-results .stat-value {
            font-size: 1.4rem; /* Larger value font */
            font-weight: 900;
            color: #FACC15; /* Yellow for values */
        }
        .bottom-stats-and-results .results-bar {
            grid-column: 1 / -1; /* Span full width */
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.6rem;
            margin-top: 1.2rem;
            padding-top: 0.8rem;
            border-top: 2px dashed #60A5FA; /* Separator */
        }
        .bottom-stats-and-results .results-bar .result-logo img {
            width: 45px; /* Slightly larger logos */
            height: 45px;
            object-fit: contain;
            border-radius: 50%;
            border: 2px solid #FACC15;
            box-shadow: 0 0 5px rgba(250, 204, 21, 0.5);
        }
        .bottom-stats-and-results .results-bar .result-label {
            font-size: 1rem;
            color: #D1D5DB;
            font-weight: 700;
            width: 100%;
            margin-bottom: 0.6rem;
        }


        /* Keyframes for animations */
        @keyframes pulse-win {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
            100% { transform: translateX(0); }
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none; /* Initially hidden */
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.active {
            display: flex; /* Show when active */
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: #1A202C; /* Dark background for general modal */
            border-radius: 1.5rem;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.6);
            padding: 1.5rem;
            max-width: 600px;
            width: 90%;
            text-align: center;
            border: 1px solid #4A5568;
            color: #E0F2F7;
            position: relative;
            transform: translateY(-50px);
            transition: transform 0.3s ease;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }

        /* Specific modal styling for results screen matching the image */
        .modal-content.results-modal {
            background: linear-gradient(to bottom, #34D399 0%, #10B981 100%); /* Green gradient for results modal */
            border: 2px solid #065F46;
            color: white; /* White text for contrast */
            padding: 2.5rem 1.5rem; /* More padding */
        }
        .modal-content.results-modal.lose {
            background: linear-gradient(to bottom, #EF4444 0%, #B91C1C 100%); /* Red gradient for losing results */
            border: 2px solid #991B1B;
        }

        .modal-close-button {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #FACC15; /* Default yellow close button */
            cursor: pointer;
            transition: color 0.2s ease;
        }
        .modal-close-button:hover {
            color: #FDE047;
        }
        .modal-content.results-modal .modal-close-button {
            color: white; /* White close button for green/red background */
        }

        .modal-title {
            color: #FACC15;
            font-size: 1.8rem;
            font-weight: 900;
            margin-bottom: 1.5rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .modal-content.results-modal .modal-title {
            color: white; /* White title for results modal */
            font-size: 2.2rem;
            text-shadow: 0 0 10px rgba(255,255,255,0.5);
            margin-bottom: 1rem;
        }

        .modal-result-message {
            font-size: 1.6rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: white; /* White text */
        }
        .modal-content.results-modal .round-status-display {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: rgba(255,255,255,0.8);
        }
        .modal-content.results-modal .result-detail {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: rgba(0,0,0,0.2);
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            margin-bottom: 0.75rem;
            font-size: 1.1rem;
            font-weight: 600;
        }
        .modal-content.results-modal .result-detail span:last-child {
            font-weight: 900;
            color: #FACC15; /* Yellow for values */
        }

        .modal-section {
            background-color: #2D3748; /* Darker background for general modal sections */
            border-radius: 1rem;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid #4A5568;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2); 
        }
        .modal-content.results-modal .modal-section {
             background-color: rgba(0,0,0,0.3); /* Transparent dark for results modal sections */
             border-color: rgba(255,255,255,0.3);
             box-shadow: none;
             margin-top: 1.5rem;
        }
        .modal-section-title {
            color: #D1D5DB;
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
        }
        .modal-content.results-modal .modal-section-title {
            color: white;
            text-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .man-of-the-match-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            justify-content: center;
            align-items: flex-start;
        }
        .player-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            background-color: #1A202C; /* Even darker for player cards */
            border-radius: 0.75rem;
            padding: 0.75rem;
            border: 1px solid #4A5568;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .modal-content.results-modal .player-card {
            background-color: rgba(255,255,255,0.1); /* Lighter for results modal */
            border-color: rgba(255,255,255,0.3);
            color: white;
        }
        .player-card.top1 {
            background: linear-gradient(to top, #FACC15, #FDE047); /* Gold gradient */
            color: #1A202C;
            border-color: #FFD700;
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(250, 204, 21, 0.5);
        }
        .player-card.top1 .player-rank, .player-card.top1 .player-score, .player-card.top1 .player-name {
            color: #1A202C; /* Dark text for top1 */
        }
        .player-card.top2 {
            background: linear-gradient(to top, #A1A1AA, #D4D4D8); /* Silver gradient */
            color: #1A202C;
            border-color: #C0C0C0;
        }
        .player-card.top2 .player-rank, .player-card.top2 .player-score, .player-card.top2 .player-name {
            color: #1A202C;
        }
        .player-card.top3 {
            background: linear-gradient(to top, #BF814F, #D7B57B); /* Bronze gradient */
            color: #1A202C;
            border-color: #CD7F32;
        }
        .player-card.top3 .player-rank, .player-card.top3 .player-score, .player-card.top3 .player-name {
            color: #1A202C;
        }


        .player-card img {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #FACC15; /* Yellow border for avatar */
            box-shadow: 0 0 5px rgba(250, 204, 21, 0.5);
        }
        .modal-content.results-modal .player-card img {
            border-color: white; /* White border for results modal players */
        }
        .player-card .player-rank {
            font-size: 0.75rem;
            font-weight: 600;
            color: #9CA3AF;
        }
        .player-card .player-name {
            font-size: 0.9rem;
            font-weight: 700;
            color: #E0F2F7;
        }
        .player-card .player-score {
            font-size: 1rem;
            font-weight: 900;
            color: #FACC15;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .game-container {
                padding: 1rem;
                border-radius: 1rem;
                gap: 1rem;
            }
            h1 {
                font-size: 2.2rem;
            }
            .top-bar {
                flex-direction: column;
                gap: 0.5rem;
                padding: 0.5rem 1rem;
            }
            .timer-center {
                font-size: 3.5rem;
                padding: 0.8rem 1.5rem;
            }
            .teams-grid {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
                gap: 0.8rem;
            }
            .team-card {
                padding: 0.6rem;
            }
            .team-card img {
                width: 70px;
                height: 70px;
            }
            .team-card span {
                font-size: 0.85rem;
            }
            .team-card .multiplier {
                font-size: 0.7rem;
                padding: 2px 8px;
            }
            .team-card .bet-amount-display {
                font-size: 0.7rem;
                padding: 2px 8px;
            }
            .bet-amounts-group {
                gap: 0.6rem;
                padding: 0.6rem 1rem;
            }
            .bet-amount-button {
                padding: 0.5rem 1rem;
                font-size: 0.8rem;
                min-width: 50px;
            }
            .action-buttons-group {
                gap: 0.8rem;
            }
            .action-button {
                padding: 0.6rem 1.2rem;
                font-size: 0.9rem;
            }
            .action-button.large-value-bet {
                padding: 0.6rem 0.8rem;
                min-width: 100px;
            }
            .action-button.large-value-bet .bet-label {
                font-size: 0.7rem;
            }
            .action-button.large-value-bet .bet-value {
                font-size: 1rem;
            }
            .message-area {
                font-size: 1.1rem;
                min-height: 3rem;
            }
            .bottom-stats-and-results {
                grid-template-columns: 1fr;
                gap: 0.8rem;
                padding: 1rem;
            }
            .bottom-stats-and-results .stat-label {
                font-size: 0.8rem;
            }
            .bottom-stats-and-results .stat-value {
                font-size: 1.1rem;
            }
            .bottom-stats-and-results .results-bar .result-logo img {
                width: 35px;
                height: 35px;
            }
            .modal-content {
                padding: 1rem;
                border-radius: 1rem;
            }
            .modal-title {
                font-size: 1.8rem;
            }
            .modal-result-message {
                font-size: 1.2rem;
            }
            .modal-content.results-modal {
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- Top Bar Section -->
        <div class="top-bar">
            <div class="info-item">
                <i class="fas fa-signal"></i>
                <span>مستوى الدروة يتسارع</span>
            </div>
            <div class="info-item">
                <i class="fas fa-calendar-alt"></i>
                <span>08:00-07:00 جدول الساعة</span>
            </div>
            <div class="balance-display">
                <i class="fas fa-coins text-yellow-300"></i>
                <span class="value" id="balanceDisplay"></span>
            </div>
        </div>

        <h1>الجولة <span id="roundNumberDisplay">1207</span> لليوم</h1>
        <p class="description"></p> <!-- Removed text here -->

        <!-- Main Game Area -->
        <div class="main-game-area">
            <div class="timer-center" id="timerDisplay">
                <span class="remaining-text">متبقي على الإختيار</span>
            </div>

            <div id="teamsGrid" class="teams-grid">
                <!-- Team cards will be injected here by JavaScript -->
            </div>

            <div class="bet-amounts-group" id="betAmountButtons">
                <button class="bet-amount-button" data-bet="10">10</button>
                <button class="bet-amount-button" data-bet="100">100</button>
                <button class="bet-amount-button" data-bet="1000">1000</button>
            </div>

            <div class="action-buttons-group">
                <button class="action-button" id="replayLastBetButton">اختر نفس رهان الجولة السابقة</button>
            </div>

            <!-- Message Area (for in-game prompts, not end-of-round results anymore) -->
            <div id="messageArea" class="message-area"></div>
        </div>

        <!-- Bottom Stats and Results Section -->
        <div class="bottom-stats-and-results">
            <div class="stat-block">
                <span class="stat-label">مستوى الحرارة</span>
                <span class="stat-value" id="heatLevelDisplay">0</span>
            </div>
            <div class="stat-block">
                <span class="stat-label">القيمة لجميع الرهانات</span>
                <span class="stat-value" id="totalBetsValueDisplay">0</span>
            </div>
            <div class="stat-block">
                <span class="stat-label">القيمة لرهاناتي</span>
                <span class="stat-value" id="myBetsValueDisplay">0</span>
            </div>
            <div class="stat-block">
                <span class="stat-label">أرباح اليوم</span>
                <span class="stat-value" id="dailyProfitDisplay">0</span>
            </div>
            <div class="stat-block">
                <span class="stat-label">كمية الكرستال :</span>
                <span class="stat-value" id="crystalAmountDisplay">30</span>
            </div>
            <div class="results-bar">
                <span class="result-label">النتائج :</span>
                <div id="recentWinnersDisplay" class="flex gap-2">
                    <!-- Recent winner logos will be injected here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Menu Modal (now also serves as the End-of-Round Results Modal) -->
    <div id="menuModal" class="modal-overlay">
        <div class="modal-content">
            <button id="closeMenuButton" class="modal-close-button">
                <i class="fas fa-times"></i>
            </button>
            
            <h2 class="modal-title" id="modalRoundDisplay">الجولة <span id="modalRoundNumber"></span> اليوم</h2>
            <p class="modal-result-message" id="modalResultMessage"></p>
            
            <div class="round-status-display">
                <div class="result-detail">
                    <span>مكسب هذه الجولة</span>
                    <span id="modalRoundWinnings">0</span>
                </div>
                <div class="result-detail">
                    <span>الرهانات في هذه الجولة</span>
                    <span id="modalRoundBets">0</span>
                </div>
            </div>

            <!-- Man of the Match Section -->
            <div class="modal-section">
                <h3 class="modal-section-title">رجل الجولة</h3>
                <div class="man-of-the-match-grid">
                    <!-- Dummy Player Cards matching the image -->
                    <div class="player-card top1">
                        <span class="player-rank">TOP1</span>
                        <img src="https://placehold.co/70x70/fcd34d/1a063b?text=M" alt="Player 1 Avatar">
                        <span class="player-name">XTAMIMX</span>
                        <span class="player-score">600000</span>
                    </div>
                    <div class="player-card top2">
                        <span class="player-rank">TOP2</span>
                        <img src="https://placehold.co/70x70/a1a1aa/1a063b?text=S" alt="Player 2 Avatar">
                        <span class="player-name">SOLIST</span>
                        <span class="player-score">24000</span>
                    </div>
                    <div class="player-card top3">
                        <span class="player-rank">TOP3</span>
                        <img src="https://placehold.co/70x70/bf814f/1a063b?text=C" alt="Player 3 Avatar">
                        <span class="player-name">Caesar</span>
                        <span class="player-score">12000</span>
                    </div>
                </div>
            </div>

            <!-- Additional sections can be added here -->
            <div class="modal-section">
                <h3 class="modal-section-title">نجوم الدائرة</h3>
                <p class="text-sm text-gray-400">هنا ستظهر قائمة بأبرز اللاعبين في الدوائر المختلفة.</p>
                <div class="man-of-the-match-grid">
                    <div class="player-card">
                        <img src="https://placehold.co/70x70/5a5a5a/FFFFFF?text=P1" alt="Player 1 Avatar">
                        <span class="player-name">لاعب 1</span>
                        <span class="player-score">15000</span>
                    </div>
                    <div class="player-card">
                        <img src="https://placehold.co/70x70/5a5a5a/FFFFFF?text=P2" alt="Player 2 Avatar">
                        <span class="player-name">لاعب 2</span>
                        <span class="player-score">10000</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Array of football teams with their names, placeholder logo URLs, and a multiplier
        const teams = [
            // Ordered as per the provided image for 8 teams
            { id: 'city', name: 'مان سيتي', logo: 'https://placehold.co/100x100/6CACE4/FFFFFF?text=MCFC', multiplier: 40 }, // Placeholder for Man City or similar
            { id: 'realmadrid', name: 'ريال مدريد', logo: 'https://placehold.co/100x100/FACC15/000000?text=RMD', multiplier: 40 }, // Placeholder for Real Madrid
            { id: 'psg', name: 'باريس سان جيرمان', logo: 'https://placehold.co/100x100/004077/FFFFFF?text=PSG', multiplier: 12 },
            { id: 'liverpool', name: 'ليفربول', logo: 'https://placehold.co/100x100/C8102E/FFFFFF?text=LFC', multiplier: 12 },
            { id: 'milan', name: 'ميلان', logo: 'https://placehold.co/100x100/FACC15/DA291C?text=ACM', multiplier: 6 }, // Placeholder for AC Milan
            { id: 'bayern', name: 'بايرن ميونخ', logo: 'https://placehold.co/100x100/DC052B/FFFFFF?text=BAY', multiplier: 6 },
            { id: 'juventus', name: 'يوفنتوس', logo: 'https://placehold.co/100x100/000000/FFFFFF?text=JUV', multiplier: 4 },
            { id: 'manutd', name: 'مانشستر يونايتد', logo: 'https://placehold.co/100x100/DA291C/000000?text=MUFC', multiplier: 4 }
        ];

        // Get references to HTML elements
        const teamsGrid = document.getElementById('teamsGrid');
        const messageArea = document.getElementById('messageArea');
        const timerDisplay = document.getElementById('timerDisplay');
        const balanceDisplay = document.getElementById('balanceDisplay');
        const betAmountButtons = document.querySelectorAll('.bet-amount-button');
        const replayLastBetButton = document.getElementById('replayLastBetButton');

        // New display elements for bottom stats (matching new design)
        const heatLevelDisplay = document.getElementById('heatLevelDisplay'); // New stat
        const dailyProfitDisplay = document.getElementById('dailyProfitDisplay');
        const totalBetsValueDisplay = document.getElementById('totalBetsValueDisplay');
        const myBetsValueDisplay = document.getElementById('myBetsValueDisplay');
        const crystalAmountDisplay = document.getElementById('crystalAmountDisplay');
        const recentWinnersDisplay = document.getElementById('recentWinnersDisplay');
        const roundNumberDisplay = document.getElementById('roundNumberDisplay');

        // Modal elements
        const menuModal = document.getElementById('menuModal');
        const modalContent = menuModal.querySelector('.modal-content');
        const closeMenuButton = document.getElementById('closeMenuButton');
        const modalRoundNumber = document.getElementById('modalRoundNumber');
        const modalResultMessage = document.getElementById('modalResultMessage');
        const modalRoundWinnings = document.getElementById('modalRoundWinnings');
        const modalRoundBets = document.getElementById('modalRoundBets');


        // Sound effects (using Tone.js for simple beeps/tones, no external URLs)
        let audioContext;
        let oscillator;

        function playTone(frequency, duration) {
            if (!audioContext || audioContext.state === 'suspended') {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            oscillator = audioContext.createOscillator();
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);

            const gainNode = audioContext.createGain();
            gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.0001, audioContext.currentTime + duration);

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.start();
            oscillator.stop(audioContext.currentTime + duration);
        }

        function playSelectSound() { playTone(440, 0.05); }
        function playBetSound() { playTone(660, 0.1); }
        function playWinSound() { playTone(880, 0.3); }
        function playLoseSound() { playTone(220, 0.3); }
        function playTimerTickSound() { playTone(300, 0.05); }
        function playErrorSound() { playTone(150, 0.2); }


        // Game state variables - Initial values
        const INITIAL_BALANCE = 55306230;
        const INITIAL_DAILY_PROFIT = 0;
        const INITIAL_CRYSTAL_AMOUNT = 30;
        const INITIAL_HEAT_LEVEL = 10000;
        const INITIAL_ROUND_NUMBER_OFFSET = 1206; // Game starts at 1207, so this is the base.
        const MAX_ROUNDS_PLAYED = 100; // Total rounds to play before restarting


        let currentBalance = INITIAL_BALANCE;
        let dailyProfit = INITIAL_DAILY_PROFIT;
        let crystalAmount = INITIAL_CRYSTAL_AMOUNT;
        let heatLevel = INITIAL_HEAT_LEVEL;

        let betsPlacedThisRound = {}; // Stores { teamId: totalBetAmountOnThisTeamInThisRound }
        let lastRoundBets = {}; // Stores bets from the previous round for "replay" functionality

        let winningTeamId = null;
        let totalGamesPlayed = 0; // Tracks games played in current session (resets after MAX_ROUNDS)
        let wins = 0;
        let losses = 0;
        let currentRoundNumber = INITIAL_ROUND_NUMBER_OFFSET; // Actual round number in game display


        let recentWinners = []; // Will store team objects for logos

        const GAME_ROUND_DURATION = 20; // Seconds for a full game round
        let currentRoundTime = GAME_ROUND_DURATION;
        let roundInterval;

        let lastActiveBetAmount = 10; // Default active bet amount is always 10

        let spinTimeoutId; // To store the timeout for the spinning effect
        let spinIndex = 0; // Current index in the spinning loop


        /**
         * Renders all 8 team cards dynamically into the DOM.
         */
        function renderTeams() {
            console.log("renderTeams called.");
            teamsGrid.innerHTML = '';
            teams.forEach(team => { // Iterate through all 8 teams
                const teamCard = document.createElement('div');
                teamCard.id = `team-${team.id}`;
                teamCard.classList.add('team-card');
                // Added a dummy bet count to the top of some teams for visual matching from image
                // These are static and for display only, not dynamic game data
                const dummyBetCount = team.id === 'city' ? '2790' : (team.id === 'realmadrid' ? '1830' : (team.id === 'psg' ? '2850' : (team.id === 'liverpool' ? '960' : (team.id === 'milan' ? '2930' : (team.id === 'bayern' ? '1730' : (team.id === 'juventus' ? '3880' : (team.id === 'manutd' ? '3930' : '0')))))));

                teamCard.innerHTML = `
                    <span class="absolute top-2 left-2 bg-blue-700 text-white text-xs px-2 py-1 rounded-full opacity-90">${dummyBetCount} <i class="fas fa-arrow-up"></i></span> <!-- Dummy bet count -->
                    <span class="bet-amount-display"></span>
                    <img src="${team.logo}" alt="${team.name} Logo" onerror="this.onerror=null;this.src='https://placehold.co/100x100/AAAAAA/000000?text=Logo'">
                    <span>${team.name}</span>
                    <span class="multiplier">X${team.multiplier}</span>
                `;
                teamCard.addEventListener('click', () => handleTeamCardClick(team.id)); // Changed to handleTeamCardClick
                teamsGrid.appendChild(teamCard);
            });
        }

        /**
         * Resets all main game state variables to their initial values.
         * Called when the game fully restarts after reaching MAX_ROUNDS_PLAYED.
         */
        function resetGameState() {
            currentBalance = INITIAL_BALANCE;
            dailyProfit = INITIAL_DAILY_PROFIT;
            crystalAmount = INITIAL_CRYSTAL_AMOUNT;
            heatLevel = INITIAL_HEAT_LEVEL;
            currentRoundNumber = INITIAL_ROUND_NUMBER_OFFSET; // Reset round number to start fresh
            
            betsPlacedThisRound = {};
            lastRoundBets = {};
            recentWinners = []; // Clear recent winners display
            totalGamesPlayed = 0; // Reset games played counter
            wins = 0;
            losses = 0;

            console.log("Game state reset.");
        }


        /**
         * Initializes a new game round.
         * Resets state, clears messages, enables interaction, and starts timers.
         */
        function initializeGame() {
            console.log("initializeGame called.");
            
            if (totalGamesPlayed >= MAX_ROUNDS_PLAYED) { // Check if max rounds played already reached
                endGame();
                return;
            }

            currentRoundNumber++; // Increment round number for the new round display
            roundNumberDisplay.textContent = currentRoundNumber;

            betsPlacedThisRound = {}; // Clear all bets placed for this new round
            winningTeamId = null;

            messageArea.textContent = ''; // Clear message area as per request
            messageArea.className = 'message-area info';

            // Reset all team cards visual state
            document.querySelectorAll('.team-card').forEach(card => {
                card.classList.remove('selected', 'winning', 'losing', 'disabled', 'has-bet', 'selection-highlight'); // Remove all specific classes
                card.style.animation = ''; // Clear any animations
                card.style.cursor = 'pointer'; // Re-enable cursor
                card.querySelector('.bet-amount-display').textContent = ''; // Clear bet display on card
            });

            // Re-activate '10' bet button and set it as active
            lastActiveBetAmount = 10; // Ensure it's always 10 by default
            betAmountButtons.forEach(button => {
                button.disabled = false;
                button.classList.remove('active-bet-amount'); // Clear active state from all buttons
            });
            document.querySelector(`.bet-amount-button[data-bet="10"]`).classList.add('active-bet-amount'); // Set 10 as active

            // Enable action buttons based on conditions
            replayLastBetButton.disabled = Object.keys(lastRoundBets).length === 0;

            updateStatsDisplay();
            updateBalanceDisplay();
            displayRecentWinners(); // Update recent winners display
            updateBetButtonStates(); // Re-evaluate button states after initial setup
            
            clearInterval(roundInterval); // Clear any existing interval
            currentRoundTime = GAME_ROUND_DURATION; // Reset timer
            timerDisplay.textContent = `${currentRoundTime}s`; // Update timer display

            roundInterval = setInterval(() => {
                currentRoundTime--;
                timerDisplay.textContent = `${currentRoundTime}s`;
                // playTimerTickSound(); // Optional: Play a tick sound every second

                if (currentRoundTime <= 0) {
                    clearInterval(roundInterval); // Stop timer
                    timerDisplay.textContent = '0s'; // Ensure it displays 0
                    resolveGameOutcome(); // Time's up, resolve the round
                }
            }, 1000); // Update every second
        }

        /**
         * Handles the click on a team card. This now directly places/accumulates a bet.
         * @param {string} teamId - The ID of the clicked team.
         */
        function handleTeamCardClick(teamId) {
            console.log(`handleTeamCardClick called for: ${teamId} with lastActiveBetAmount: ${lastActiveBetAmount}`);
            const card = document.getElementById(`team-${teamId}`);
            const teamObj = teams.find(t => t.id === teamId);

            if (card.classList.contains('disabled')) {
                console.log(`Team ${teamId} cannot be interacted with (disabled).`);
                return;
            }

            if (lastActiveBetAmount <= 0) { // Should not happen with default 10, but a safeguard
                return; // Just return silently if no active bet amount selected
            }

            if (lastActiveBetAmount > currentBalance) {
                messageArea.textContent = `رصيدك (${currentBalance.toLocaleString()}) لا يكفي لوضع رهان ${lastActiveBetAmount.toLocaleString()} على ${teamObj.name}.`;
                messageArea.className = 'message-area error';
                playErrorSound();
                return;
            }

            // Place/accumulate bet
            currentBalance -= lastActiveBetAmount;
            betsPlacedThisRound[teamId] = (betsPlacedThisRound[teamId] || 0) + lastActiveBetAmount;
            
            card.classList.add('has-bet');
            card.classList.remove('selected'); // Ensure selection highlight is removed
            card.style.cursor = 'default';
            card.querySelector('.bet-amount-display').textContent = `${betsPlacedThisRound[teamId].toLocaleString()}`;
            
            playBetSound();
            messageArea.textContent = `تم وضع رهان ${lastActiveBetAmount.toLocaleString()} على ${teamObj.name}. إجمالي رهانك على هذا الفريق: ${betsPlacedThisRound[teamId].toLocaleString()}. رصيدك: ${currentBalance.toLocaleString()}`;
            messageArea.className = 'message-area text-gray-800';
            
            updateBalanceDisplay();
            updateBetButtonStates(); // Re-evaluate button states after bet
        }

        /**
         * Sets the active bet amount when a bet amount button is clicked.
         * @param {number} amount - The selected bet amount.
         */
        function setActiveBetAmount(amount) {
            lastActiveBetAmount = amount;
            betAmountButtons.forEach(button => {
                button.classList.remove('active-bet-amount');
            });
            document.querySelector(`.bet-amount-button[data-bet="${amount}"]`).classList.add('active-bet-amount');
            updateBetButtonStates(); // Re-evaluate bet button states (though they will remain enabled based on balance)
        }


        /**
         * Replays the bets from the last round.
         */
        function replayLastBet() {
            console.log("replayLastBet called.");
            if (Object.keys(lastRoundBets).length === 0) {
                messageArea.textContent = 'لا توجد رهانات سابقة لإعادتها!';
                messageArea.className = 'message-area error';
                playErrorSound();
                return;
            }

            // Clear current round's bets to re-apply last round's bets
            betsPlacedThisRound = {}; 

            // Temporarily enable all team cards so replay can target them, but disable for general interaction
            document.querySelectorAll('.team-card').forEach(card => {
                card.classList.remove('disabled'); // Allow us to update their state
                card.classList.remove('selected', 'has-bet', 'selection-highlight'); // Clear any current visual states
                card.querySelector('.bet-amount-display').textContent = ''; // Clear display
            });

            let totalBetCost = 0;
            for (const teamId in lastRoundBets) {
                totalBetCost += lastRoundBets[teamId];
            }

            if (totalBetCost > currentBalance) {
                messageArea.textContent = 'رصيدك لا يكفي لإعادة جميع رهانات الجولة السابقة!';
                messageArea.className = 'message-area error';
                playErrorSound();
                // Re-disable cards if not enough balance to re-bet
                document.querySelectorAll('.team-card').forEach(card => card.classList.add('disabled'));
                return;
            }

            // Place all bets from last round
            for (const teamId in lastRoundBets) {
                const betAmount = lastRoundBets[teamId];
                const teamCard = document.getElementById(`team-${teamId}`);
                
                // Since betsPlacedThisRound was cleared, this will be the initial bet for this replay
                currentBalance -= betAmount;
                betsPlacedThisRound[teamId] = betAmount;
                
                teamCard.classList.add('has-bet');
                teamCard.style.cursor = 'default';
                teamCard.querySelector('.bet-amount-display').textContent = `${betAmount.toLocaleString()}`;
                console.log(`Replayed bet ${betAmount.toLocaleString()} on ${teamId}. New balance: ${currentBalance.toLocaleString()}`);
            }
            playBetSound();
            messageArea.textContent = 'تمت إعادة رهانات الجولة السابقة!';
            messageArea.className = 'message-area text-gray-800';

            // Disable all betting options and cards after replay action
            betAmountButtons.forEach(button => button.disabled = true);
            replayLastBetButton.disabled = true;
            document.querySelectorAll('.team-card').forEach(card => card.classList.add('disabled'));

            updateBalanceDisplay();
        }

        /**
         * Starts the spinning selection animation.
         * @param {string} winningTeamId - The ID of the team that will eventually be selected.
         * @param {function} callback - Function to call after the animation completes.
         */
        function startSpinSelectionAnimation(winningTeamId, callback) {
            let initialDelay = 80; // ms, faster start
            let currentDelay = initialDelay;
            const accelerationFactor = 1.08; // How much delay increases each step (slows down)
            const totalSpinDuration = 3000; // Total duration of the spinning animation in milliseconds
            let startTime = Date.now();
            let finalTargetIndex = teams.findIndex(team => team.id === winningTeamId);
            let spinCount = 0; // To ensure at least a few full spins

            // Disable all interactions immediately before spin begins
            betAmountButtons.forEach(button => button.disabled = true);
            replayLastBetButton.disabled = true;
            document.querySelectorAll('.team-card').forEach(card => card.classList.add('disabled'));

            function animateSpin() {
                const elapsedTime = Date.now() - startTime;

                // Remove highlight from previous team
                const prevCard = document.getElementById(`team-${teams[spinIndex].id}`);
                if (prevCard) prevCard.classList.remove('selection-highlight');

                // Move to next team
                spinIndex = (spinIndex + 1) % teams.length;

                // Add highlight to current team
                const currentCard = document.getElementById(`team-${teams[spinIndex].id}`);
                if (currentCard) currentCard.classList.add('selection-highlight');

                // Play a subtle sound with each step (optional)
                // playTimerTickSound(); 

                // Determine if we should stop
                if (elapsedTime > totalSpinDuration && spinIndex === finalTargetIndex) {
                    // Spin duration is over AND we are on the final winning team
                    clearTimeout(spinTimeoutId);
                    // Keep final winner highlighted briefly
                    setTimeout(() => {
                        currentCard.classList.remove('selection-highlight');
                        callback(); // Call the rest of resolveGameOutcome
                    }, 500); // Keep highlight for 0.5 seconds then proceed
                    return;
                }

                // Calculate next delay - gradually increase delay to slow down
                currentDelay = initialDelay * Math.pow(accelerationFactor, elapsedTime / 200); // Exponential increase, adjust 200 for smoothness
                
                spinTimeoutId = setTimeout(animateSpin, currentDelay);
            }

            animateSpin(); // Start the animation
        }


        /**
         * Resolves the game outcome (win/lose) and updates UI and displays the results modal.
         */
        function resolveGameOutcome() {
            console.log("resolveGameOutcome called.");
            
            // Determine the winning team randomly from all 8 teams early
            const randomIndex = Math.floor(Math.random() * teams.length);
            winningTeamId = teams[randomIndex].id;
            const winningTeam = teams[randomIndex];
            const winningTeamName = winningTeam.name;

            // Start the spinning animation first
            startSpinSelectionAnimation(winningTeamId, () => {
                // This callback runs AFTER the spinning animation completes

                // Clean up all selection highlights
                document.querySelectorAll('.team-card').forEach(card => {
                    card.classList.remove('selection-highlight');
                });

                // Highlight the actual winning team card on the main game area (permanently for this round)
                const winningCard = document.getElementById(`team-${winningTeamId}`);
                if (winningCard) winningCard.classList.add('winning');

                totalGamesPlayed++; // Increment games played counter
                lastRoundBets = { ...betsPlacedThisRound }; // Save current round's bets for replay

                let anyBetPlaced = Object.keys(betsPlacedThisRound).length > 0;
                let roundWinnings = 0;
                let playerWonThisRound = false;
                let totalBetsThisRound = 0; // Sum of player's bets for this round

                if (anyBetPlaced) {
                    for (const teamId in betsPlacedThisRound) {
                        const betAmount = betsPlacedThisRound[teamId];
                        const teamBetOn = teams.find(t => t.id === teamId);
                        const card = document.getElementById(`team-${teamId}`);

                        totalBetsThisRound += betAmount; // Sum up all player's bets for the round

                        if (teamId === winningTeamId) {
                            const winnings = betAmount * teamBetOn.multiplier;
                            currentBalance += winnings;
                            roundWinnings += winnings;
                            dailyProfit += winnings;
                            playerWonThisRound = true;
                            if (card) card.classList.add('winning');
                            if (card) card.classList.remove('losing'); // Ensure losing is removed
                        } else {
                            dailyProfit -= betAmount; // Lost the bet, already deducted, so just update dailyProfit
                            if (card) card.classList.add('losing');
                            if (card) card.classList.remove('winning'); // Ensure winning is removed
                        }
                    }

                    // Update modal content based on win/lose
                    modalRoundNumber.textContent = currentRoundNumber;
                    modalRoundWinnings.textContent = roundWinnings.toLocaleString(); // Format winnings
                    modalRoundBets.textContent = totalBetsThisRound.toLocaleString(); // Format total bets

                    if (playerWonThisRound) {
                        wins++;
                        modalResultMessage.textContent = `تهانينا! الفريق الفائز هو ${winningTeamName}! لن تسير وحدك أبداً.`;
                        modalContent.classList.add('results-modal');
                        modalContent.classList.remove('lose'); // Ensure lose class is removed
                        playWinSound();
                    } else {
                        losses++;
                        modalResultMessage.textContent = `انتهى الوقت! الفريق الفائز هو ${winningTeamName}. آسف لأنك لم تفز!`;
                        modalContent.classList.add('results-modal', 'lose'); // Add lose class for red background
                        playLoseSound();
                    }
                } else { // No bets were placed at all in this round
                    modalRoundNumber.textContent = currentRoundNumber;
                    modalResultMessage.textContent = `انتهى الوقت! لم يتم وضع أي رهان. الفريق الفائز كان: ${winningTeamName}.`;
                    modalRoundWinnings.textContent = '0';
                    modalRoundBets.textContent = '0';
                    modalContent.classList.add('results-modal');
                    modalContent.classList.remove('lose'); // Ensure lose class is removed
                    // No specific sound for no bet, but perhaps a neutral tone or none
                }

                // Update recent winners display in the main game area
                recentWinners.unshift(winningTeam); // Add to beginning
                if (recentWinners.length > 5) { // Keep only last 5 winners
                    recentWinners.pop();
                }
                displayRecentWinners();

                updateBalanceDisplay();
                updateStatsDisplay();

                // Show the modal after results are processed
                menuModal.classList.add('active'); // This should make the modal visible

                // Auto-close modal and start next round after 5 seconds OR end game
                setTimeout(() => {
                    menuModal.classList.remove('active'); // This should hide the modal
                    if (totalGamesPlayed >= MAX_ROUNDS_PLAYED) { // Check total rounds played
                        endGame();
                    } else {
                        initializeGame(); // This will start the next 20-second cycle
                    }
                }, 5000); // 5 seconds to view results before new round starts
            }); // End of startSpinSelectionAnimation callback
        }

        /**
         * Ends the game and resets it to start from round 0.
         */
        function endGame() {
            console.log("Game Over! Max rounds reached. Restarting game.");
            clearInterval(roundInterval);
            timerDisplay.textContent = "انتهت اللعبة!";
            messageArea.textContent = `انتهت اللعبة بعد ${MAX_ROUNDS_PLAYED} جولة! سيتم إعادة تشغيل اللعبة...`;
            messageArea.className = 'message-area win'; // Green message for game over, before restart

            // Disable all interaction elements
            betAmountButtons.forEach(button => button.disabled = true);
            replayLastBetButton.disabled = true;
            document.querySelectorAll('.team-card').forEach(card => card.classList.add('disabled'));

            // After a short delay, reset the game state and initialize a new game
            setTimeout(() => {
                resetGameState(); // Reset all core game variables
                initializeGame(); // Start a brand new game
            }, 5000); // Wait 5 seconds before restarting completely
        }


        /**
         * Displays recent winners' logos.
         */
        function displayRecentWinners() {
            console.log("displayRecentWinners called.");
            recentWinnersDisplay.innerHTML = '';
            recentWinners.forEach(team => {
                const img = document.createElement('img');
                img.src = team.logo;
                img.alt = team.name;
                img.classList.add('result-logo');
                img.onerror = function() { // Fallback for image loading errors
                    this.src = 'https://placehold.co/40x40/AAAAAA/000000?text=Logo';
                };
                recentWinnersDisplay.appendChild(img);
            });
        }


        /**
         * Updates the display for current balance and new stats.
         */
        function updateBalanceDisplay() {
            console.log("updateBalanceDisplay called. Current Balance:", currentBalance);
            balanceDisplay.textContent = currentBalance.toLocaleString(); // Use toLocaleString for large numbers
            dailyProfitDisplay.textContent = dailyProfit.toLocaleString(); // Update daily profit
            heatLevelDisplay.textContent = heatLevel.toLocaleString(); // Update heat level

            let totalMyBets = 0;
            for (const teamId in betsPlacedThisRound) {
                totalMyBets += betsPlacedThisRound[teamId];
            }
            myBetsValueDisplay.textContent = totalMyBets.toLocaleString();
            // totalBetsValueDisplay is a dummy for now, could be sum of all bets across all players if multiplayer
            totalBetsValueDisplay.textContent = (totalMyBets * 2 + 5000).toLocaleString(); // Dummy value, adjusted for visual effect
        }

        /**
         * Updates the display for total games, wins, and losses.
         */
        function updateStatsDisplay() {
            console.log("updateStatsDisplay called.");
            crystalAmountDisplay.textContent = crystalAmount.toLocaleString();
        }

        /**
         * Enables/disables bet amount buttons and replay button based on game state.
         */
        function updateBetButtonStates() {
            console.log("updateBetButtonStates called.");
            // Bet amount buttons are always enabled if balance allows, as they set the lastActiveBetAmount
            betAmountButtons.forEach(button => {
                const bet = parseInt(button.dataset.bet);
                button.disabled = (bet > currentBalance);
            });

            // Replay button disabled if no last bets OR if any bets are already placed this round
            replayLastBetButton.disabled = Object.keys(lastRoundBets).length === 0 || Object.keys(betsPlacedThisRound).length > 0;
        }

        // Event Listeners for bet amount buttons (now call setActiveBetAmount)
        betAmountButtons.forEach(button => {
            button.addEventListener('click', () => {
                const bet = parseInt(button.dataset.bet);
                setActiveBetAmount(bet);
            });
        });

        // Event listener for replay last bet button
        replayLastBetButton.addEventListener('click', replayLastBet);

        // Modal Event Listeners (results modal will show automatically)
        closeMenuButton.addEventListener('click', () => {
            menuModal.classList.remove('active');
        });

        // Close modal if clicked outside content
        menuModal.addEventListener('click', (event) => {
            if (event.target === menuModal) {
                menuModal.classList.remove('active');
            }
        });


        // Initial setup when the window loads
        window.onload = () => {
            console.log("window.onload called.");
            renderTeams();
            initializeGame(); // This will also set initial timer and balance display
        };
    </script>
</body>
</html>